<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tawheed Center - Check In</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDK (using compat version - works without local server) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCDlTpIAYsCCJiOdcdntHH69N5KcGcOLfU",
            authDomain: "tawheed-checkin.firebaseapp.com",
            databaseURL: "https://tawheed-checkin-default-rtdb.firebaseio.com",
            projectId: "tawheed-checkin",
            storageBucket: "tawheed-checkin.firebasestorage.app",
            messagingSenderId: "1006226812211",
            appId: "1:1006226812211:web:18f86c3190b4cb5cd3e246"
        };

        // Initialize Firebase
        let db = null;
        let checkinsRef = null;

        try {
            console.log('Initializing Firebase...');
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            checkinsRef = db.ref('checkins');
            window.firebaseDb = {
                db,
                checkinsRef,
                set: (ref, data) => ref.set(data),
                update: (ref, data) => ref.update(data),
                remove: (ref) => ref.remove(),
                onValue: (ref, callback, errCallback) => ref.on('value', callback, errCallback),
                ref: (path) => db.ref(path)
            };
            window.firebaseReady = true;
            console.log('‚úÖ Firebase initialized successfully!');
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            console.error('Error details:', error.message, error.stack);
            window.firebaseDb = null;
            window.firebaseReady = false;
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 12px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { display: flex; align-items: center; gap: 10px; }
        .logo { height: 52px; width: auto; display: block; object-fit: contain; }
        .header-text h1 { font-size: 1.2rem; margin-bottom: 2px; }
        .header-text p { font-size: 0.8rem; opacity: 0.9; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #e0e0e0; padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .sidebar-section { padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .sidebar-title { font-size: 0.75rem; text-transform: uppercase; color: #666; margin-bottom: 10px; font-weight: 600; letter-spacing: 0.5px; }
        .stats { background: #e9ecef; padding: 10px; border-radius: 6px; }
        .stat-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #dee2e6; }
        .stat-item:last-child { border-bottom: none; }
        .stat-label { color: #666; font-size: 0.8rem; }
        .stat-value { color: #1e3c72; font-weight: 600; font-size: 0.85rem; }
        .content { flex: 1; padding: 15px; overflow-y: auto; }
        .search-container { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .search-label { font-size: 0.85rem; color: #666; margin-bottom: 8px; display: block; }
        .search-input-wrapper { position: relative; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 1rem; color: #999; }
        .search-input { width: 100%; padding: 10px 15px 10px 40px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; transition: all 0.3s; }
        .search-input:focus { outline: none; border-color: #1e3c72; box-shadow: 0 0 0 3px rgba(30,60,114,0.1); }
        .search-input:disabled { background: #f5f5f5; cursor: not-allowed; }
        .search-hint { margin-top: 8px; color: #999; font-size: 0.8rem; }
        .results-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; }
        .result-card { background: white; border-radius: 4px; padding: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); animation: fadeIn 0.3s ease; border-left: 3px solid #ddd; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .result-card.found { border-left-color: #28a745; }
        .result-card.not-found { border-left-color: #dc3545; background: #fff5f5; }
        .result-header { display: flex; align-items: center; gap: 3px; margin-bottom: 4px; padding-bottom: 3px; border-bottom: 1px solid #eee; }
        .result-icon { font-size: 0.85rem; }
        .result-title { font-size: 0.8rem; color: #333; }
        .result-card.found .result-title { color: #28a745; }
        .result-card.not-found .result-title { color: #dc3545; }
        .result-details { display: grid; gap: 1px; }
        .result-row { display: flex; justify-content: space-between; padding: 1px 0; border-bottom: 1px solid #f0f0f0; }
        .result-row:last-child { border-bottom: none; }
        .result-label { color: #666; font-size: 0.7rem; }
        .result-value { color: #333; font-weight: 500; text-align: right; max-width: 60%; word-break: break-word; font-size: 0.75rem; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 15px; }
        .empty-state h3 { color: #666; margin-bottom: 8px; font-size: 1.1rem; }
        .loading { text-align: center; color: #666; padding: 30px; }
        .spinner { display: inline-block; width: 25px; height: 25px; border: 3px solid #f3f3f3; border-top: 3px solid #1e3c72; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        footer { background: #1e3c72; color: white; text-align: center; padding: 10px; font-size: 0.8rem; }
        .match-count { background: #1e3c72; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; margin-bottom: 5px; display: inline-block; }

        /* Ticket Summary */
        .ticket-summary { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 4px; padding: 4px; margin-bottom: 4px; }
        .donor-name-row { background: #f8f9fa; padding: 3px; border-radius: 3px; margin-bottom: 3px; }

        /* Status */
        .auto-load-status { padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.85rem; }
        .auto-load-status.success { background: #d4edda; color: #155724; }
        .auto-load-status.error { background: #f8d7da; color: #721c24; }
        .auto-load-status.loading { background: #e9ecef; color: #666; }
        .refresh-btn { background: #1e3c72; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 0.85rem; margin-top: 8px; width: 100%; }
        .refresh-btn:hover { background: #2a5298; }

        /* Check-in Section Styles */
        .checkin-section {
            margin-top: 6px;
            padding: 6px 8px;
            background: #f0f4f8;
            border-radius: 5px;
            border: 1px solid #d0dbe4;
        }
        .checkin-header {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 5px;
        }
        .checkin-status-icon { font-size: 0.85rem; }
        .checkin-title { font-size: 0.75rem; font-weight: 600; color: #1e3c72; }
        .checkin-counter { text-align: center; margin-bottom: 3px; }
        .counter-display { font-size: 1rem; font-weight: 700; color: #1e3c72; }
        .counter-display .separator { margin: 0 2px; color: #999; }
        .counter-display .total-count { color: #666; }
        .counter-label { display: block; font-size: 0.65rem; color: #666; margin-top: 1px; }
        .checkin-controls { display: flex; align-items: center; gap: 8px; margin-bottom: 3px; }
        .btn { border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-weight: 700; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-minus { background: #dc3545; color: white; flex: 1; padding: 8px; font-size: 1rem; }
        .btn-minus:hover:not(:disabled) { background: #c82333; }
        .btn-plus { background: #28a745; color: white; flex: 1; padding: 8px; font-size: 1rem; }
        .btn-plus:hover:not(:disabled) { background: #218838; }
        .btn-reset { background: #dc3545; color: white; width: 100%; padding: 12px; font-size: 1.1rem; font-weight: 700; }
        .btn-reset:hover { background: #c82333; }
        .checkin-progress { height: 5px; background: #e9ecef; border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #28a745 0%, #34d57e 100%); border-radius: 4px; transition: width 0.3s ease; }
        .progress-bar.complete { background: linear-gradient(90deg, #1e7e34 0%, #28a745 100%); }
        .checkin-section.complete { background: #d4edda; border-color: #c3e6cb; }
        .checkin-section.complete .checkin-title { color: #155724; }

        /* ‚îÄ‚îÄ Mobile responsive ‚îÄ‚îÄ */
        @media (max-width: 640px) {
            .header { padding: 10px 14px; }
            .logo { height: 38px; }
            .header-text h1 { font-size: 1rem; }
            .header-text p { font-size: 0.7rem; }

            /* Stack sidebar above content */
            .main-container { flex-direction: column; overflow: visible; }

            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 10px;
                padding: 10px 14px;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                overflow-y: visible;
            }
            .sidebar-section {
                flex: 1 1 auto;
                min-width: 140px;
                padding-bottom: 0;
                border-bottom: none;
            }

            .content { padding: 10px 14px; overflow-y: visible; }

            /* Full-width single column cards on mobile */
            .results-container { grid-template-columns: 1fr; }

            /* Bigger touch targets for buttons */
            .btn-minus, .btn-plus { padding: 12px; font-size: 1.1rem; }
            .btn-reset { padding: 14px; font-size: 1rem; }
            .refresh-btn { padding: 10px; font-size: 0.9rem; }

            /* Larger search input */
            .search-input { font-size: 1rem; padding: 12px 15px 12px 42px; }

            /* Bigger counter text */
            .counter-display { font-size: 1.2rem; }

            /* Wider result values */
            .result-value { max-width: 70%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <img class="logo" src="https://www.tawheedcenter.org/wp-content/uploads/2020/03/whitelogo.png" alt="Tawheed Center">
            <div class="header-text">
                <h1>Tawheed Center</h1>
                <p id="headerEventTitle">Check In</p>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">üìÅ Data Status</div>
                <div id="loadStatus" class="auto-load-status loading">
                    <div class="spinner"></div> Loading data...
                </div>
                <button id="refreshBtn" class="refresh-btn" style="display: none;" onclick="loadData()">
                    üîÑ Refresh Data
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">‚ÑπÔ∏è Instructions</div>
                <div style="color: #666; font-size: 0.8rem; line-height: 1.5;">
                    <p>1. Page auto-loads data</p>
                    <p>2. Type a registrant name to search</p>
                    <p>3. Use <strong>‚àí</strong> to decrease check-in (uncheck 1)</p>
                    <p>4. Use <strong>+</strong> to increase check-in (check in 1)</p>
                </div>
            </div>
        </aside>

        <main class="content">
            <div class="search-container">
                <label class="search-label" for="searchInput">Search by Registrant Name</label>
                <div class="search-input-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="Loading data..." disabled autocomplete="off">
                </div>
                <div class="search-hint" id="searchHint">Waiting for data...</div>
            </div>

            <div id="results">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <h3>Loading Data...</h3>
                    <p>Please wait while the registration data loads</p>
                </div>
            </div>
        </main>
    </div>

    <footer>Tawheed Center Check In System</footer>

    <script>
        // registrationData: array of { displayName, normalizedName, adultCount, childCount, totalTickets }
        let registrationData = [];
        let checkinData = {};
        let searchTimeout = null;

        const searchInput = document.getElementById('searchInput');
        const searchHint = document.getElementById('searchHint');
        const results = document.getElementById('results');
        const loadStatus = document.getElementById('loadStatus');
        const refreshBtn = document.getElementById('refreshBtn');

        async function loadData() {
            searchInput.disabled = true;
            searchInput.placeholder = "Loading data...";
            searchHint.textContent = "Loading...";
            loadStatus.className = 'auto-load-status loading';
            loadStatus.innerHTML = '<div class="spinner"></div> Loading data...';
            refreshBtn.style.display = 'none';

            try {
                const response = await fetch('https://tawheed-checkin.web.app/all-tickets.xlsx');
                if (!response.ok) throw new Error('Could not load all-tickets.xlsx');

                loadStatus.innerHTML = '<div class="spinner"></div> Processing...';
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                // Find the real header row (contains "Donor" column)
                let headerRowIndex = 0;
                for (let i = 0; i < Math.min(rows.length, 10); i++) {
                    if (rows[i] && rows[i].some(h => h && h.toString().toLowerCase().trim() === 'donor')) {
                        headerRowIndex = i;
                        break;
                    }
                }
                const headers = rows[headerRowIndex];
                const donorCol = headers.findIndex(h => h && h.toString().toLowerCase().trim() === 'donor');
                const typeCol  = headers.findIndex(h => h && h.toString().toLowerCase().includes('ticket') && h.toString().toLowerCase().includes('type'));

                if (donorCol === -1) throw new Error('Could not find "Donor" column');

                const phoneCol      = headers.findIndex(h => h && h.toString().toLowerCase().trim() === 'phone number');
                const emailCol      = headers.findIndex(h => h && h.toString().toLowerCase().trim() === 'email address');
                const eventTitleCol = headers.findIndex(h => h && h.toString().toLowerCase().trim() === 'event title');
                const feeCol        = headers.findIndex(h => h && h.toString().toLowerCase().trim() === 'ticket fee');

                // Fill down donor names, then group by normalized name
                const donorMap = {};
                let lastDonor = '';
                rows.slice(headerRowIndex + 1).forEach(row => {
                    if (row[donorCol] && row[donorCol].toString().trim()) {
                        lastDonor = row[donorCol].toString().trim();
                    }
                    if (!lastDonor) return;

                    const key = lastDonor.toUpperCase();
                    if (!donorMap[key]) {
                        donorMap[key] = {
                            displayName: lastDonor,
                            normalizedName: key,
                            adultCount: 0,
                            childCount: 0,
                            totalTickets: 0,
                            totalFee: 0,
                            phone: '',
                            email: '',
                            eventTitle: ''
                        };
                    }

                    // Capture contact details from first row of this donor
                    if (!donorMap[key].phone && phoneCol >= 0 && row[phoneCol]) {
                        donorMap[key].phone = row[phoneCol].toString().trim();
                    }
                    if (!donorMap[key].email && emailCol >= 0 && row[emailCol]) {
                        donorMap[key].email = row[emailCol].toString().trim();
                    }
                    if (!donorMap[key].eventTitle && eventTitleCol >= 0 && row[eventTitleCol]) {
                        donorMap[key].eventTitle = row[eventTitleCol].toString().trim();
                    }

                    const ticketType = typeCol >= 0 && row[typeCol] ? row[typeCol].toString().toLowerCase() : '';
                    if (ticketType.includes('adult')) {
                        donorMap[key].adultCount++;
                    } else if (ticketType.includes('child')) {
                        donorMap[key].childCount++;
                    }

                    if (feeCol >= 0) {
                        const fee = parseFloat(row[feeCol]);
                        if (!isNaN(fee)) donorMap[key].totalFee += fee;
                    }

                    donorMap[key].totalTickets++;
                });

                registrationData = Object.values(donorMap);

                loadStatus.className = 'auto-load-status success';
                const totalRows = rows.slice(headerRowIndex + 1).filter(r => r.some(c => c !== undefined && c !== '' && c !== null)).length;
                const firstEventTitle = registrationData.find(d => d.eventTitle)?.eventTitle;
                if (firstEventTitle) {
                    document.getElementById('headerEventTitle').textContent = firstEventTitle + ' - Check In';
                }

                loadStatus.innerHTML = '‚úì Loaded ' + totalRows + ' registrants';
                refreshBtn.style.display = 'block';

                searchInput.disabled = false;
                searchInput.placeholder = "Start typing a registrant name...";
                searchHint.textContent = "Type at least 2 characters to search";
                showEmptyState();

            } catch (error) {
                console.error('Error loading Excel:', error);
                loadStatus.className = 'auto-load-status error';
                loadStatus.innerHTML = '‚úó Error: ' + error.message;
                refreshBtn.style.display = 'block';
            }
        }

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            if (!query) { showEmptyState(); return; }
            searchTimeout = setTimeout(() => performSearch(query), 200);
        });

        function performSearch(query) {
            if (query.length < 2) { showEmptyState(); return; }
            results.innerHTML = '<div class="loading"><div class="spinner"></div>Searching...</div>';
            const matches = registrationData.filter(d =>
                d.displayName.toLowerCase().includes(query.toLowerCase())
            );
            displayResults(matches, query);
        }

        function displayResults(matches, query) {
            results.innerHTML = '';

            if (matches.length === 0) {
                results.innerHTML = '<div class="result-card not-found"><div class="result-header"><span class="result-icon">‚ùå</span><span class="result-title">No Match Found</span></div><p>No registrant found matching "' + escapeHtml(query) + '"</p></div>';
                return;
            }

            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'results-container';

            matches.forEach(donor => {
                const card = document.createElement('div');
                card.className = 'result-card found';

                const donorName    = donor.displayName;
                const normalizedName = donor.normalizedName;
                const totalTickets = donor.totalTickets;
                const adultCount   = donor.adultCount;
                const childCount   = donor.childCount;
                const totalFee     = donor.totalFee;

                const checkinInfo = checkinData[normalizedName] || { checkedIn: 0, total: totalTickets };
                const checkedIn = checkinInfo.checkedIn || 0;
                const remaining = totalTickets - checkedIn;
                const isComplete = checkedIn >= totalTickets;
                const percentage = totalTickets > 0 ? (checkedIn / totalTickets) * 100 : 0;

                let html = '';
                html += '<div class="ticket-summary" style="padding: 8px;">';
                html += '<div style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">';
                html += '<div style="text-align: center; padding: 4px 8px; background: #d4edda; border-radius: 5px; min-width: 55px;"><span style="display: block; font-size: 1.2rem; font-weight: 700; color: #333;">' + adultCount + '</span><span style="font-size: 0.65rem; color: #666;">üë§ Adult' + (adultCount !== 1 ? 's' : '') + '</span></div>';
                html += '<div style="text-align: center; padding: 4px 8px; background: #fff3cd; border-radius: 5px; min-width: 55px;"><span style="display: block; font-size: 1.2rem; font-weight: 700; color: #333;">' + childCount + '</span><span style="font-size: 0.65rem; color: #666;">üë∂ Child' + (childCount !== 1 ? 'ren' : '') + '</span></div>';
                if (totalFee > 0) {
                    html += '<div style="text-align: center; padding: 4px 10px; background: #d1ecf1; border-radius: 5px; min-width: 60px; border: 1px solid #28a745;"><span style="display: block; font-size: 1.2rem; font-weight: 700; color: #28a745;">$' + totalFee + '</span><span style="font-size: 0.65rem; color: #666;">Amount</span></div>';
                }
                html += '</div></div>';

                html += '<div class="result-details">';
                html += '<div class="result-row donor-name-row"><span class="result-label">Registrant:</span><span class="result-value" style="color: #1e3c72; font-weight: 600;">' + escapeHtml(donorName) + '</span></div>';
                if (donor.phone)      html += '<div class="result-row"><span class="result-label">Phone Number:</span><span class="result-value">' + escapeHtml(donor.phone) + '</span></div>';
                if (donor.email)      html += '<div class="result-row"><span class="result-label">Email Address:</span><span class="result-value">' + escapeHtml(donor.email) + '</span></div>';
                if (donor.eventTitle) html += '<div class="result-row"><span class="result-label">Event Title:</span><span class="result-value">' + escapeHtml(donor.eventTitle) + '</span></div>';
                html += '</div>';

                html += '<div class="checkin-section' + (isComplete ? ' complete' : '') + '">';
                html += '<div class="checkin-header">';
                html += '<span class="checkin-status-icon">' + (isComplete ? '‚úÖ' : 'üìã') + '</span>';
                html += '<span class="checkin-title">' + (isComplete ? 'Fully Checked In' : 'Check-in Status') + '</span>';
                html += '</div>';

                html += '<div class="checkin-counter">';
                html += '<div class="counter-display">';
                html += '<span class="checked-in-count">' + checkedIn + '</span>';
                html += '<span class="separator">/</span>';
                html += '<span class="total-count">' + totalTickets + '</span>';
                html += '</div>';
                html += '<span class="counter-label">' + remaining + ' ticket' + (remaining !== 1 ? 's' : '') + ' remaining</span>';
                html += '</div>';

                html += '<div class="checkin-controls">';
                html += '<button class="btn btn-minus" onclick="decrementCheckIn(\'' + escapeForOnclick(donorName) + '\')" ' + (checkedIn === 0 ? 'disabled' : '') + '>‚àí</button>';
                html += '<button class="btn btn-plus" onclick="checkInTickets(\'' + escapeForOnclick(donorName) + '\', 1)" ' + (checkedIn >= totalTickets ? 'disabled' : '') + '>+</button>';
                html += '</div>';

                html += '<div class="checkin-progress">';
                html += '<div class="progress-bar' + (isComplete ? ' complete' : '') + '" style="width: ' + percentage + '%"></div>';
                html += '</div>';
                html += '</div>';

                card.innerHTML = '<div class="result-header"><span class="result-icon">‚úÖ</span><span class="result-title">Registration Found</span></div>' + html;
                resultsContainer.appendChild(card);
            });

            results.appendChild(resultsContainer);
        }

        function showEmptyState() {
            results.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><h3>Start Searching</h3><p>Type a registrant name to see results</p></div>';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function normalizeDonorName(donorName) {
            return donorName.toString().trim().toUpperCase();
        }

        function escapeForOnclick(text) {
            return text
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n');
        }

        function loadCheckinData() {
            const checkReady = setInterval(() => {
                if (window.firebaseReady && window.firebaseDb) {
                    clearInterval(checkReady);
                    window.firebaseDb.onValue(window.firebaseDb.checkinsRef, (snapshot) => {
                        checkinData = snapshot.val() || {};
                        if (searchInput.value.trim().length >= 2) {
                            performSearch(searchInput.value.trim());
                        }
                    }, (error) => {
                        console.error('Firebase read error:', error);
                    });
                }
            }, 100);
            setTimeout(() => clearInterval(checkReady), 10000);
        }

        function saveCheckinData() {
            if (!window.firebaseDb) {
                console.error('Firebase not initialized');
                alert('Database not connected. Check-in cannot be saved.');
                return;
            }

            const { update } = window.firebaseDb;

            update(window.firebaseDb.checkinsRef, checkinData)
                .then(() => console.log('Check-in data saved to Firebase'))
                .catch(error => {
                    console.error('Error saving to Firebase:', error);
                    alert('Could not save check-in data. Please check your connection.');
                });
        }

        function getCheckinInfo(donorName, totalTickets) {
            const normalizedName = normalizeDonorName(donorName);
            if (!checkinData[normalizedName]) {
                return { checkedIn: 0, total: totalTickets };
            }
            return checkinData[normalizedName];
        }

        function updateCheckButtonLabel(qtyInputId) {
            var input = document.getElementById(qtyInputId);
            var btn = document.getElementById('btn-' + qtyInputId);
            if (!input || !btn) return;
            var n = parseInt(input.value, 10);
            if (isNaN(n) || n < 1) n = 1;
            btn.textContent = 'Check in ' + n + (n === 1 ? ' ticket' : ' tickets');
        }

        function checkInFromInput(donorName, qtyInputId) {
            var input = document.getElementById(qtyInputId);
            if (!input) return;
            var count = parseInt(input.value, 10);
            if (isNaN(count) || count < 1) {
                alert('Please enter a number (1 or more).');
                return;
            }
            checkInTickets(donorName, count);
            input.value = '1';
        }

        function checkInTickets(donorName, count) {
            const normalizedName = normalizeDonorName(donorName);
            const donor = registrationData.find(d => d.normalizedName === normalizedName);
            const totalTickets = donor ? donor.totalTickets : 0;

            if (!checkinData[normalizedName]) {
                checkinData[normalizedName] = { checkedIn: 0, total: totalTickets, lastUpdated: new Date().toISOString() };
            }

            const newCheckedIn = checkinData[normalizedName].checkedIn + count;
            const maxAllowed = checkinData[normalizedName].total || totalTickets;

            if (newCheckedIn > maxAllowed) {
                alert(`Cannot check in more than ${maxAllowed} tickets. Only ${maxAllowed - checkinData[normalizedName].checkedIn} remaining.`);
                return;
            }

            checkinData[normalizedName].checkedIn = newCheckedIn;
            checkinData[normalizedName].lastUpdated = new Date().toISOString();
            saveCheckinData();

            const searchInput = document.getElementById('searchInput');
            if (searchInput.value.trim().length >= 2) {
                performSearch(searchInput.value.trim());
            }
        }

        function decrementCheckIn(donorName) {
            const normalizedName = normalizeDonorName(donorName);

            if (!checkinData[normalizedName]) return;

            if (checkinData[normalizedName].checkedIn > 0) {
                checkinData[normalizedName].checkedIn--;
                checkinData[normalizedName].lastUpdated = new Date().toISOString();
                saveCheckinData();

                const searchInput = document.getElementById('searchInput');
                if (searchInput.value.trim().length >= 2) {
                    performSearch(searchInput.value.trim());
                }
            }
        }

        function resetCheckIn(donorName) {
            const normalizedName = normalizeDonorName(donorName);

            if (!checkinData[normalizedName]) return;

            if (confirm('Reset check-in count to 0 for ' + donorName + '?')) {
                checkinData[normalizedName].checkedIn = 0;
                checkinData[normalizedName].lastUpdated = new Date().toISOString();
                saveCheckinData();

                const searchInput = document.getElementById('searchInput');
                if (searchInput.value.trim().length >= 2) {
                    performSearch(searchInput.value.trim());
                }
            }
        }

        window.addEventListener('load', () => {
            loadCheckinData();
            loadData();
        });
    </script>
</body>
</html>
